# Two-Band Filter å¯¦ç¾å®Œæˆæ‘˜è¦

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ¨¡çµ„ (3å€‹æ–‡ä»¶)

#### `track_manager.py` - è¿½è¹¤ç‹€æ…‹ç®¡ç†å™¨
- âœ… `TrackState` è³‡æ–™é¡ï¼šå„²å­˜å–®ä¸€ç‰©é«”çš„è¿½è¹¤ç‹€æ…‹
- âœ… `TrackManager` é¡ï¼šç®¡ç†æ‰€æœ‰è¿½è¹¤ç‰©é«”
- âœ… ä¸­å¿ƒé»é£„ç§»æª¢æ¸¬ï¼ˆ2Ã— å®¹å·®ï¼‰
- âœ… ä¿¡åº¦ç©©å®šæ€§æª¢æ¸¬
- âœ… Entry/Trigger/Exit Zone é‚Šç•Œç®¡ç†
- âœ… è¿½è¹¤è¶…æ™‚è™•ç†ï¼ˆ15 å¸§ï¼‰
- âœ… çµ±è¨ˆè³‡è¨Šï¼ˆæ´»å‹•è¿½è¹¤ã€å·²è§¸ç™¼è¿½è¹¤ï¼‰

#### `blow_controller.py` - æ°£å¹æ§åˆ¶å™¨
- âœ… `BlowCommand` è³‡æ–™é¡ï¼šå„²å­˜æ°£å¹æŒ‡ä»¤
- âœ… `BlowController` é¡ï¼šæ°£å¹æ§åˆ¶é‚è¼¯
- âœ… TCP è¨Šæ¯æ ¼å¼è½‰æ›
- âœ… ACK ç¢ºèªæ©Ÿåˆ¶
- âœ… è¶…æ™‚æª¢æ¸¬ï¼ˆ200msï¼‰
- âœ… æˆåŠŸ/å¤±æ•—è¨˜éŒ„
- âœ… çµ±è¨ˆè³‡è¨Šï¼ˆæˆåŠŸç‡ã€å¤±æ•—æ¬¡æ•¸ï¼‰

#### `two_band_filter.py` - ä¸»æ§ç³»çµ±
- âœ… `TwoBandFilter` é¡ï¼šæ•´åˆæ‰€æœ‰åŠŸèƒ½
- âœ… ä¸‰æ¢ä»¶è§¸ç™¼é‚è¼¯
  - æ¢ä»¶1: ä¸­å¿ƒé»åœ¨ Trigger Zone
  - æ¢ä»¶2: å°šæœªè§¸ç™¼é
  - æ¢ä»¶3: ä¿¡åº¦ â‰¥ 0.75
- âœ… é¡å¤–ç©©å®šæ€§æª¢æŸ¥ï¼ˆé£„ç§»ã€ä¿¡åº¦æ³¢å‹•ï¼‰
- âœ… è¦–è¦ºåŒ–åŠŸèƒ½
  - `visualize_zones()`: ç¹ªè£½å€åŸŸé‚Šç•Œ
  - `draw_tracks()`: ç¹ªè£½è¿½è¹¤çµæœ
- âœ… çµ±è¨ˆè³‡è¨Šæ•´åˆ

### 2. é…ç½®ç³»çµ± (1å€‹æ–‡ä»¶)

#### `config_two_band_filter.py` - é…ç½®ç®¡ç†
- âœ… 6å€‹é…ç½®é¡åˆ¥
  - `ZoneConfig`: è¦–é‡åˆ†å€
  - `LensConfig`: é¡é ­åƒæ•¸
  - `DetectionConfig`: åµæ¸¬åƒæ•¸
  - `TrackingConfig`: è¿½è¹¤åƒæ•¸
  - `BlowConfig`: æ°£å¹åƒæ•¸
  - `TCPConfig`: TCP é€šè¨Š
  - `ImageConfig`: å½±åƒå°ºå¯¸
  - `MonitoringConfig`: ç›£æ§é–¾å€¼
- âœ… é è¨­å ´æ™¯é…ç½®
  - 12mm + é«˜é€Ÿ
  - 8mm + ä½é€Ÿ
  - åš´æ ¼æ¨¡å¼
  - å¯¬é¬†æ¨¡å¼
- âœ… é…ç½®æª”æ¡ˆå„²å­˜/è¼‰å…¥ï¼ˆJSONï¼‰

### 3. æ–‡æª” (3å€‹æ–‡ä»¶)

#### `claude.md` - è¨­è¨ˆæ–‡æª”
- âœ… ç³»çµ±æ¦‚è¿°
- âœ… è¦–é‡åˆ†å€è¨­è¨ˆ
- âœ… è§¸ç™¼æ©Ÿåˆ¶æµç¨‹
- âœ… åƒæ•¸é…ç½®èªªæ˜
- âœ… ç•°å¸¸è™•ç†æ©Ÿåˆ¶
- âœ… å®Œæ•´ä»£ç¢¼ç¯„ä¾‹
- âœ… æ€§èƒ½ç›£æ§æŒ‡æ¨™

#### `README_TWO_BAND_FILTER.md` - ä½¿ç”¨æŒ‡å—
- âœ… å¿«é€Ÿé–‹å§‹æ•™å­¸
- âœ… API æ–‡æª”
- âœ… æ•´åˆæŒ‡å—
- âœ… åƒæ•¸èªªæ˜
- âœ… æ¸¬è©¦èªªæ˜

#### `example_two_band_filter.py` - ç¯„ä¾‹ç¨‹å¼
- âœ… æ¨¡æ“¬æ¸¬è©¦ç¯„ä¾‹
- âœ… è¦–è¦ºåŒ–ç¯„ä¾‹
- âœ… æ•´åˆä»£ç¢¼å±•ç¤º
- âœ… äº’å‹•å¼é¸å–®

---

## ğŸ“ ç³»çµ±æ¶æ§‹

```
Two-Band Filter ç³»çµ±
â”‚
â”œâ”€â”€ æ ¸å¿ƒæ¨¡çµ„
â”‚   â”œâ”€â”€ two_band_filter.py          # ä¸»æ§é¡ï¼Œæ•´åˆæ‰€æœ‰åŠŸèƒ½
â”‚   â”œâ”€â”€ track_manager.py            # è¿½è¹¤ç‹€æ…‹ç®¡ç†
â”‚   â””â”€â”€ blow_controller.py          # æ°£å¹æ§åˆ¶
â”‚
â”œâ”€â”€ é…ç½®ç®¡ç†
â”‚   â””â”€â”€ config_two_band_filter.py   # åƒæ•¸é…ç½®
â”‚
â”œâ”€â”€ æ–‡æª”
â”‚   â”œâ”€â”€ claude.md                   # è¨­è¨ˆæ–‡æª”
â”‚   â”œâ”€â”€ README_TWO_BAND_FILTER.md   # ä½¿ç”¨æŒ‡å—
â”‚   â””â”€â”€ example_two_band_filter.py  # ç¯„ä¾‹ç¨‹å¼
â”‚
â””â”€â”€ ç¾æœ‰ç³»çµ±ï¼ˆéœ€æ•´åˆï¼‰
    â”œâ”€â”€ CamOperation_class.py       # ç›¸æ©Ÿæ“ä½œ
    â”œâ”€â”€ tcp_server.py               # TCP é€šè¨Š
    â””â”€â”€ detect.py / YOLO            # ç‰©é«”åµæ¸¬
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### è¦–é‡åˆ†å€ (Three-Zone System)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Y = 0
â”‚         ENTRY ZONE              â”‚  é–‹å§‹è¿½è¹¤ã€åˆ†é… ID
â”‚     (Y < IMAGE_H Ã— 0.375)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Y = IMAGE_H Ã— 0.375
â”‚        TRIGGER ZONE             â”‚  â˜… å”¯ä¸€è§¸ç™¼å€åŸŸ
â”‚  (IMAGE_H Ã— 0.375 ~ 0.625)      â”‚  ä½”è¦–é‡ä¸­å¤® 25%
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Y = IMAGE_H Ã— 0.625
â”‚         EXIT ZONE               â”‚  æ¸…é™¤è¿½è¹¤ç‹€æ…‹
â”‚     (Y > IMAGE_H Ã— 0.625)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Y = IMAGE_H
```

### è§¸ç™¼æ¢ä»¶

**å¿…è¦æ¢ä»¶ï¼ˆä¸‰å€‹åŒæ™‚æ»¿è¶³ï¼‰ï¼š**
1. âœ… ä¸­å¿ƒé» cy åœ¨ Trigger Zone å…§
2. âœ… è©²ç‰©é«”çš„ `triggered` æ——æ¨™ç‚º `false`
3. âœ… é¡åˆ¥ä¿¡åº¦ â‰¥ 0.75

**ç©©å®šæ€§æª¢æŸ¥ï¼š**
4. âœ… ä¸­å¿ƒé»é£„ç§» < 2Ã— å®¹å·®
5. âœ… ä¿¡åº¦ç©©å®šï¼ˆç„¡åŠ‡çƒˆæ³¢å‹•ï¼‰

### ç•°å¸¸è™•ç†

| ç•°å¸¸æƒ…æ³ | è™•ç†æ–¹å¼ |
|----------|----------|
| ä¸­å¿ƒé»é£„ç§»è¶…é 2Ã— å®¹å·® | æš«åœè§¸ç™¼ï¼Œç¹¼çºŒè¿½è¹¤ |
| ä¿¡åº¦ä¸è¶³ï¼ˆ< 0.75ï¼‰ | è·³éè©²å¸§ï¼Œç¹¼çºŒç­‰å¾… |
| ç‰©é«”æ¶ˆå¤±å¾Œé‡ç¾ | è¦–ç‚ºæ–°ç‰©é«”ï¼Œé‡æ–°åˆ†é… ID |
| æ°£å¹ ACK è¶…æ™‚ï¼ˆ> 200msï¼‰ | æ¨™è¨˜ç‚ºæœªè™•ç†ï¼Œè¨˜éŒ„å¤±æ•— |

---

## ğŸ“Š é—œéµåƒæ•¸

### å€åŸŸåƒæ•¸

| åƒæ•¸ | å€¼ | èªªæ˜ |
|------|-----|------|
| Entry Zone ä¸‹é‚Šç•Œ | IMAGE_H Ã— 0.375 | é–‹å§‹è¿½è¹¤ |
| Trigger Zone ç¯„åœ | IMAGE_H Ã— 0.375 ~ 0.625 | è§¸ç™¼å€åŸŸï¼ˆ25%ï¼‰ |
| Exit Zone ä¸Šé‚Šç•Œ | IMAGE_H Ã— 0.625 | æ¸…é™¤è¿½è¹¤ |

### é¡é ­åƒæ•¸

| é¡é ­ | ä¸­å¿ƒé»å®¹å·® | é£„ç§»é–¾å€¼ |
|------|-----------|----------|
| 12mm | Â±5 pixels | Â±10 pixels |
| 8mm  | Â±8 pixels | Â±16 pixels |

### å…¶ä»–åƒæ•¸

| åƒæ•¸ | å€¼ | èªªæ˜ |
|------|-----|------|
| ä¿¡åº¦é–¾å€¼ | 0.75 | æœ€ä½ä¿¡åº¦è¦æ±‚ |
| è¿½è¹¤è¶…æ™‚ | 15 å¸§ | é€£çºŒæœªåµæ¸¬çš„ä¸Šé™ |
| æ°£å¹å»¶é² | 80~120 ms | æŒ‡ä»¤åˆ°å¯¦éš›å™´æ°£ |
| ACK è¶…æ™‚ | 200 ms | ç­‰å¾…ç¢ºèªçš„æ™‚é–“ |

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### 1. åŸºæœ¬åˆå§‹åŒ–

```python
from two_band_filter import TwoBandFilter
from tcp_server import get_tcp_server

# å•Ÿå‹• TCP ä¼ºæœå™¨
start_tcp_server(host='localhost', port=8888)

# åˆå§‹åŒ– Two-Band Filter
filter_system = TwoBandFilter(
    image_width=1280,
    image_height=1024,
    lens_type="12mm",
    tcp_server=get_tcp_server()
)
```

### 2. è™•ç†æ¯ä¸€å¸§

```python
# åœ¨ç›¸æ©Ÿå–åœ–è¿´åœˆä¸­
while True:
    # YOLO åµæ¸¬
    detections = yolo_model(frame)
    
    # ç‰©é«”è¿½è¹¤ï¼ˆéœ€è¦å¯¦ç¾ï¼‰
    tracker_results = tracker.update(detections)
    
    # Two-Band Filter è™•ç†
    result = filter_system.process_frame(detections, tracker_results)
    
    # æŸ¥çœ‹è§¸ç™¼çµæœ
    if result['triggered_this_frame']:
        print(f"Triggered {len(result['triggered_this_frame'])} objects")
```

### 3. ä½¿ç”¨é…ç½®ç³»çµ±

```python
from config_two_band_filter import get_config_for_scenario

# ç²å–å ´æ™¯é…ç½®
config = get_config_for_scenario("12mm_high_speed")
config.print_config()

# ä½¿ç”¨é…ç½®åˆå§‹åŒ–
filter_system = TwoBandFilter(
    image_width=config.image.image_width,
    image_height=config.image.image_height,
    lens_type=config.lens.lens_type,
    confidence_threshold=config.detection.confidence_threshold,
    tracking_timeout_frames=config.tracking.tracking_timeout_frames,
    tcp_server=tcp_server
)
```

---

## ğŸ”§ æ•´åˆåˆ°ç¾æœ‰ç³»çµ±

### éœ€è¦æ·»åŠ çš„åŠŸèƒ½

1. **ç‰©é«”è¿½è¹¤å™¨**ï¼ˆå¿…é ˆï¼‰
   - æ¨è–¦ï¼šByteTrack æˆ– DeepSORT
   - ç”¨é€”ï¼šç‚ºåµæ¸¬åˆ°çš„ç‰©é«”åˆ†é…å’Œç¶­è­· Track ID
   
2. **æ•´åˆåˆ° CamOperation_class.py**
   ```python
   # åœ¨ Work_thread å‡½æ•¸ä¸­
   from two_band_filter import TwoBandFilter
   
   # åˆå§‹åŒ–ï¼ˆä¸€æ¬¡ï¼‰
   self.two_band_filter = TwoBandFilter(...)
   
   # æ¯å¸§è™•ç†
   result = self.two_band_filter.process_frame(detections, tracker_results)
   ```

### è¿½è¹¤å™¨ç¯„ä¾‹ï¼ˆByteTrackï¼‰

```python
# å®‰è£: pip install bytetrack

from bytetrack import BYTETracker

# åˆå§‹åŒ–è¿½è¹¤å™¨
tracker = BYTETracker(
    track_thresh=0.5,
    track_buffer=30,
    match_thresh=0.8,
    frame_rate=30
)

# æ›´æ–°è¿½è¹¤
online_targets = tracker.update(
    output_results=detections,  # YOLO çµæœ
    img_info=img.shape[:2],
    img_size=img.shape[:2]
)

# è½‰æ›ç‚º Two-Band Filter æ ¼å¼
tracker_results = [
    (track.track_id, track.tlbr)  # tlbr = [x1, y1, x2, y2]
    for track in online_targets
]
```

---

## ğŸ“ˆ æ€§èƒ½ç›£æ§

### çµ±è¨ˆæŒ‡æ¨™

```python
# ç²å–çµ±è¨ˆ
stats = filter_system.get_statistics()

# æˆ–åˆ—å°
filter_system.print_statistics()
```

### è¼¸å‡ºç¯„ä¾‹

```
============================================================
TWO-BAND FILTER STATISTICS
============================================================
Frames Processed:    1523
Active Tracks:       3
Triggered Tracks:    47
Total Triggers:      47
Skipped (Reasons):   15
------------------------------------------------------------

============================================================
BLOW CONTROLLER STATISTICS
============================================================
Total Blows:     47
Successful:      45 (95.7%)
Failed (Timeout): 2
Pending:         0
============================================================
```

### è­¦æˆ’é–¾å€¼

| æŒ‡æ¨™ | è­¦æˆ’å€¼ | èªªæ˜ |
|------|--------|------|
| è§¸ç™¼æˆåŠŸç‡ | < 95% | éœ€æª¢æŸ¥ TCP é€£ç·šæˆ–æ§åˆ¶å™¨ |
| é‡è¤‡è§¸ç™¼ç‡ | > 0% | ç‰©é«”æœªæ­£ç¢ºæ¨™è¨˜ç‚ºå·²è§¸ç™¼ |
| è¿½è¹¤ä¸Ÿå¤±ç‡ | > 10% | éœ€èª¿æ•´è¿½è¹¤åƒæ•¸æˆ–æª¢æŸ¥åµæ¸¬å“è³ª |
| å¹³å‡ä¿¡åº¦ | < 0.85 | éœ€æª¢æŸ¥ YOLO æ¨¡å‹æˆ–å½±åƒå“è³ª |

---

## ğŸ§ª æ¸¬è©¦

### é‹è¡Œç¯„ä¾‹ç¨‹å¼

```bash
# 1. è¦–è¦ºåŒ–å€åŸŸ
python example_two_band_filter.py
# é¸æ“‡ 1

# 2. æ¨¡æ“¬æ¸¬è©¦
python example_two_band_filter.py
# é¸æ“‡ 2

# 3. æŸ¥çœ‹æ•´åˆä»£ç¢¼
python example_two_band_filter.py
# é¸æ“‡ 3
```

### æ¸¬è©¦é…ç½®ç³»çµ±

```bash
python config_two_band_filter.py
```

---

## âš ï¸ æ³¨æ„äº‹é …

### å¿…é ˆå¯¦ç¾çš„éƒ¨åˆ†

1. **ç‰©é«”è¿½è¹¤å™¨**ï¼šç³»çµ±ä¾è³´è¿½è¹¤å™¨æä¾› Track ID
2. **æ•´åˆåˆ°ç›¸æ©Ÿå–åœ–è¿´åœˆ**ï¼šéœ€è¦ä¿®æ”¹ `CamOperation_class.py`
3. **TCP ä¼ºæœå™¨å•Ÿå‹•**ï¼šç¢ºä¿ TCP ä¼ºæœå™¨å·²é‹è¡Œ

### å¯é¸åŠŸèƒ½

1. **è¦–è¦ºåŒ–**ï¼šç”¨æ–¼é™¤éŒ¯å’Œå±•ç¤º
2. **çµ±è¨ˆè¨˜éŒ„**ï¼šè¨˜éŒ„åˆ°æ–‡ä»¶ä¾›å¾ŒçºŒåˆ†æ
3. **é…ç½®èª¿æ•´**ï¼šæ ¹æ“šå¯¦éš›å‚³å¸¶é€Ÿåº¦èª¿æ•´åƒæ•¸

---

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ

1. **é¸æ“‡ä¸¦æ•´åˆè¿½è¹¤å™¨**
   - ByteTrackï¼ˆæ¨è–¦ï¼Œè¼•é‡å¿«é€Ÿï¼‰
   - DeepSORTï¼ˆæ›´ç©©å®šä½†è¼ƒæ…¢ï¼‰
   - å…¶ä»–è¿½è¹¤æ¼”ç®—æ³•

2. **ä¿®æ”¹ CamOperation_class.py**
   - åœ¨ `Work_thread` ä¸­æ·»åŠ  Two-Band Filter
   - åˆå§‹åŒ–è¿½è¹¤å™¨
   - è™•ç†è¿½è¹¤çµæœ

3. **æ¸¬è©¦èˆ‡èª¿å„ª**
   - åœ¨å¯¦éš›å‚³å¸¶ä¸Šæ¸¬è©¦
   - æ ¹æ“šæˆåŠŸç‡èª¿æ•´åƒæ•¸
   - ç›£æ§æ€§èƒ½æŒ‡æ¨™

4. **å»ºç«‹ç›£æ§ç•Œé¢**ï¼ˆå¯é¸ï¼‰
   - å³æ™‚é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
   - è¦–è¦ºåŒ–è¿½è¹¤çµæœ
   - è­¦å ±ç³»çµ±

---

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. `claude.md` - å®Œæ•´è¨­è¨ˆæ–‡æª”
2. `README_TWO_BAND_FILTER.md` - ä½¿ç”¨æŒ‡å—
3. `example_two_band_filter.py` - ç¯„ä¾‹ä»£ç¢¼

---

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2026-02-03
**ç‹€æ…‹**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œç­‰å¾…æ•´åˆæ¸¬è©¦
